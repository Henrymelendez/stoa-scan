{% extends "base.html" %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <i class="fas fa-plus-circle"></i> Create New Security Scan
        </div>
        
        <form method="POST">
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                {{ form.target_url.label(class="form-label") }}
                {{ form.target_url(class="form-control", placeholder="https://example.com or 192.168.1.100") }}
                {% if form.target_url.errors %}
                    <div class="error-message">
                        {% for error in form.target_url.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-help">
                    <i class="fas fa-info-circle"></i>
                    Examples: https://example.com, 192.168.1.100, subdomain.company.com
                </small>
            </div>
            
            <div class="form-group">
                {{ form.scan_type.label(class="form-label") }}
                {{ form.scan_type(class="form-control", onchange="updateScanTypeInfo()") }}
                {% if form.scan_type.errors %}
                    <div class="error-message">
                        {% for error in form.scan_type.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                {{ form.scan_name.label(class="form-label") }}
                {{ form.scan_name(class="form-control", placeholder="Will be auto-generated if left blank") }}
                {% if form.scan_name.errors %}
                    <div class="error-message">
                        {% for error in form.scan_name.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div id="scanTypeInfo" class="scan-type-info">
                <div class="info-card">
                    <h4>Web Application Scan</h4>
                    <p>Comprehensive security testing for web applications including OWASP Top 10 vulnerabilities.</p>
                    <ul>
                        <li>SQL Injection detection</li>
                        <li>Cross-Site Scripting (XSS)</li>
                        <li>Authentication bypass</li>
                        <li>Directory traversal</li>
                        <li>SSL/TLS configuration</li>
                    </ul>
                    <div class="info-stats">
                        <div class="stat"><strong>Duration:</strong> 15-30 minutes</div>
                        <div class="stat"><strong>Tools:</strong> OWASP ZAP, Nmap</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                {{ form.scan_preset.label(class="form-label") }}
                {{ form.scan_preset(class="form-control", onchange="updatePresetInfo()") }}
                {% if form.scan_preset.errors %}
                    <div class="error-message">
                        {% for error in form.scan_preset.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label">Security Tools</label>
                <div class="checkbox-container">
                    {{ form.enable_nmap() }}
                    {{ form.enable_nmap.label() }}
                </div>
                <div class="checkbox-container">
                    {{ form.enable_zap() }}
                    {{ form.enable_zap.label() }}
                </div>
                <div class="checkbox-container">
                    {{ form.enable_metasploit() }}
                    {{ form.enable_metasploit.label() }}
                </div>
            </div>
            
            <div class="warning-box">
                <h4><i class="fas fa-exclamation-triangle"></i> Important Notice</h4>
                <p>Only scan targets you own or have explicit permission to test. Unauthorized scanning may violate laws and terms of service.</p>
            </div>
            
            <div class="form-actions" style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-play"></i> Launch Scan
                </button>
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    .scan-type-info {
        margin: 1.5rem 0;
    }

    .info-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .info-card h4 {
        margin: 0 0 1rem 0;
        color: var(--text-dark);
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .info-card ul {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }

    .info-card li {
        margin-bottom: 0.5rem;
        color: var(--text-muted);
    }

    .info-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
    }

    .stat {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .warning-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 1rem;
        margin: 1.5rem 0;
        border-left: 4px solid #f59e0b;
    }

    .warning-box h4 {
        color: #92400e;
        margin-bottom: 0.5rem;
    }

    .warning-box p {
        color: #92400e;
        margin: 0;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .error-message {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .form-help {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: block;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function updateScanTypeInfo() {
        const scanType = document.getElementById('scan_type').value;
        const infoDiv = document.getElementById('scanTypeInfo');
        
        const scanInfo = {
            'web': {
                title: 'Web Application Scan',
                description: 'Comprehensive security testing for web applications including OWASP Top 10 vulnerabilities.',
                features: [
                    'SQL Injection detection',
                    'Cross-Site Scripting (XSS)',
                    'Authentication bypass',
                    'Directory traversal',
                    'SSL/TLS configuration'
                ],
                duration: '15-30 minutes',
                tools: 'OWASP ZAP, Nmap'
            },
            'network': {
                title: 'Network Infrastructure Scan',
                description: 'Port scanning and network service enumeration to identify potential attack vectors.',
                features: [
                    'Port scanning',
                    'Service enumeration',
                    'OS fingerprinting',
                    'Firewall detection',
                    'Network topology mapping'
                ],
                duration: '10-20 minutes',
                tools: 'Nmap, Custom scanners'
            },
            'exploit': {
                title: 'Exploit Testing',
                description: 'Advanced penetration testing using known exploits and attack techniques.',
                features: [
                    'Automated exploitation',
                    'Privilege escalation',
                    'Post-exploitation',
                    'Payload delivery',
                    'Defense evasion'
                ],
                duration: '30-60 minutes',
                tools: 'Metasploit, Custom exploits'
            },
            'comprehensive': {
                title: 'Comprehensive Security Scan',
                description: 'Complete security assessment combining all scan types for thorough coverage.',
                features: [
                    'Full web application testing',
                    'Network infrastructure assessment',
                    'Automated exploitation attempts',
                    'Detailed vulnerability analysis',
                    'Complete attack surface mapping'
                ],
                duration: '45-90 minutes',
                tools: 'All available tools'
            }
        };
        
        const info = scanInfo[scanType];
        if (info) {
            infoDiv.innerHTML = `
                <div class="info-card">
                    <h4>${info.title}</h4>
                    <p>${info.description}</p>
                    <ul>
                        ${info.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                    <div class="info-stats">
                        <div class="stat"><strong>Duration:</strong> ${info.duration}</div>
                        <div class="stat"><strong>Tools:</strong> ${info.tools}</div>
                    </div>
                </div>
            `;
        }
    }
    
    function updatePresetInfo() {
        // Add preset info updates if needed
    }
    
    // Auto-update scan name based on target and type
    function updateScanName() {
        const target = document.getElementById('target_url').value;
        const scanType = document.getElementById('scan_type').value;
        const nameField = document.getElementById('scan_name');
        
        if (!nameField.value && target) {
            let hostname = target;
            try {
                if (target.startsWith('http')) {
                    hostname = new URL(target).hostname;
                }
            } catch (e) {
                // Keep original target if URL parsing fails
            }
            
            nameField.value = `${scanType.charAt(0).toUpperCase() + scanType.slice(1)} scan of ${hostname}`;
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        updateScanTypeInfo();
        
        // Auto-update scan name when target or type changes
        document.getElementById('target_url').addEventListener('blur', updateScanName);
        document.getElementById('scan_type').addEventListener('change', function() {
            updateScanTypeInfo();
            updateScanName();
        });
    });
</script>
{% endblock %}